[tox]
envlist =
    buildfixture
    py27
    py34
    py35
    py36
skipsdist = true

[testenv]
skip_install = true
deps =
    six
    flake8
    pytest
commands =
    pip install -f {distdir} -e {distdir}/nirum_fixture
    pip install -f {distdir} -e {distdir}/nirum_fixture_async
    flake8 test/python
    pytest -vv -s test/python

[testenv:buildfixture]
skip_install = true
deps =
passenv = *
whitelist_externals =
    stack
commands =
    stack exec -- nirum -o {distdir}/nirum_fixture -t python test/nirum_fixture
    stack exec -- nirum -o {distdir}/nirum_fixture_async -t python test/nirum_fixture_async

[testenv:devruntime]
; Use this when the tests against the Python source code generated by
; the compiler require the bleeding-edge version of nirum-python runtime
; (which is not released yet).
skip_install = true
deps =
    wget >= 3.2
    wheel >= 0.29.0
changedir = {envtmpdir}
whitelist_externals =
    mkdir
commands =
    python -m wget -o devruntime.zip https://github.com/{env:DEVRUNTIME_REPO:spoqa/nirum-python}/archive/{env:DEVRUNTIME_REF:master}.zip
    python -m zipfile -e devruntime.zip .
    python -c 'import glob, os.path; [os.rename(f, os.path.join(".", os.path.basename(f))) for f in glob.glob("nirum-python-*/*")]'
    python setup.py sdist bdist_wheel
    mkdir {distdir}
    python -c 'import glob, os, sys; [os.rename(f, os.path.join(sys.argv[1], os.path.basename(f))) for f in glob.glob("dist/nirum-*")]' {distdir}
